<!--
 * @Date: 2024-06-02
 * @LastEditors: GoKo-Son626
 * @LastEditTime: 2024-07-05
 * @FilePath: \STM32_Study\基础篇\8.认识HAL库.md
 * @Description: 
-->

# 认识HAL库

> 内容目录：
>
>       1. 初始HAL库
>       2. STM32Cube固件包浅析
>       3. HALk库框架结构
>       4. 如何使用HAL库
>       5. HAL库使用注意事项

#### 1. 初识HAL库

1. CMSIS简介
> CMSIS（微控制器软件接口标准）：是由ARM和与其合作的芯片厂商，软件工具厂商，共同制定的标准

| 层次            | 内容               |
| --------------- | ------------------ |
| 用户层          | 用户代码           |
| 中间层（CMSIS） | 包含Peripheral HAL |
| 硬件层          |

2. HAL简介
> ST提供了三种库：
>   - 标准外设库
>   - HAL库（硬件抽象层）
>   - LL库
#### 2. STM32Cube固件包浅析
1. 获取STM32Cube固件包（上一个章节已讲）
2. STM32Cube固件包文件夹简介

| 文件夹名称 | 文件夹名称                | 作用                                             |
| ---------- | ------------------------- | ------------------------------------------------ |
| Drivers    | BAP                       | 班级支持包，用于适配ST官方的开发板               |
| Drivers    | **SIS**                   | 符合CMISI的组件，DSP库，启动文件等               |
| Drivers    | **STM32F1xxx_HAL_Driver** | HAL库外设启动源码，包括F1系列HAL库源文件和头文件 |



 3. Drivers/CMSIS/Device/ST/STM32F1中include和Source文件夹中文件重要文件介绍：

| 文件名称                               | 描述                                                                                               |
| -------------------------------------- | -------------------------------------------------------------------------------------------------- |
| stm32f1xx.h                            | 是所有F1系列的顶层头文件，通过条件编译来包含某个芯片的头文件，定义通用的枚举类型，定义通用的宏定义 |
| stm32f103xe.h                          | 包含:中断编号定义、外设寄存器结构体类型定义、寄存器映射寄存器位定义、外设判定                      |
| system_stm32f1xx.c和system_stm32f1xx.h | 定义了系统初始化函数SystemInit和系统时钟更新函数SystemCoreClockUpdate                              |
| startup_stm32f103xe.s                  | 大容量F103系列芯片的启动文件                                                                       |
#### 3. HAL库框架结构

**HAL库文件介绍：**
- 核心文件
stm32fxxx_hal.c 和 stm32fxxx_hal.h
- 外设驱动文件
stm32fxxx_hal_gpio.c 和 stm32fxxx_hal_gpio.h
- CMSIS库
core_cm4.h
- 设备配置文件
stm32fxxx_hal_conf.h
- 启动文件
startup_stm32fxxx.s
- 系统初始化文件
system_stm32fxxx.c 和 system_stm32fxxx.h
- 板级支持包（BSP）
提供对开发板特定外设的初始化和操作函数
> HAL库通过一组标准化的API，极大地简化了STM32微控制器的开发。它提供了对各种外设的抽象和封装，使得开发者可以专注于应用层逻辑，而不必深入了解底层硬件细节。HAL库的组成包括核心库文件、外设驱动库、CMSIS库、设备配置文件、启动文件、系统初始化文件、板级支持包以及丰富的示例代码。通过这些文件，HAL库为开发者提供了一个完整的开发框架，便于快速、方便地使用STM32微控制器及其各种外设。

###### 1. Drivers文件夹

- **在STM32 HAL库工程中，Drivers文件夹包含了硬件抽象层（HAL）相关的所有驱动程序。这个文件夹的结构通常如下：**

        Drivers
        ├── CMSIS
        │   ├── Device    //包含CMSIS标准库文件
        │   │   └── ST
        │   │       └── STM32F4xx
        │   │           └── Include
        │   │           └── Source
        │   └── Include
        ├── STM32F4xx_HAL_Driver    //包含HAL库的核心和外设驱动文件
        │   ├── Inc
        │   └── Src
        └── BSP    //初始化和控制开发板上的外设等
            ├── Components
            └── STM32F4-Discovery

**各文件夹的内容及其作用:**

- **CMSIS（Cortex Microcontroller Software Interface Standard）**
 CMSIS是ARM Cortex微控制器的硬件抽象层标准。它提供了一致的接口，简化了Cortex-M微控制器的应用开发。
1. CMSIS/Include：包含CMSIS核心的头文件，例如core_cm4.h，定义了Cortex-M4内核的寄存器和中断向量等。
2. CMSIS/Device/ST/STM32F4xx/Include：包含特定于STM32F4系列的头文件，例如stm32f4xx.h，定义了设备特定的寄存器和外设。
3. CMSIS/Device/ST/STM32F4xx/Source：包含特定于STM32F4系列的启动代码和系统初始化代码，例如startup_stm32f4xx.s和system_stm32f4xx.c。

- **STM32F4xx_HAL_Driver**
HAL（Hardware Abstraction Layer）驱动程序是ST官方提供的驱动库，封装了对STM32外设的操作，使得开发者可以更高效地编写应用程序。
1. STM32F4xx_HAL_Driver/Inc：包含HAL库的头文件，例如stm32f4xx_hal.h、stm32f4xx_hal_gpio.h等。这些文件声明了各个外设的初始化和操作函数。
2. STM32F4xx_HAL_Driver/Src：包含HAL库的源文件，例如stm32f4xx_hal.c、stm32f4xx_hal_gpio.c等。这些文件实现了头文件中声明的各个外设的操作函数。

- **BSP（Board Support Package）**
BSP是板级支持包，包含与具体开发板相关的驱动和配置。

1. BSP/Components：包含特定组件（如传感器、显示屏等）的驱动程序。
2. BSP/STM32F4-Discovery：包含与STM32F4-Discovery开发板相关的驱动程序和配置，例如LED、按键、外部存储器等。

**各文件夹的作用和联系**
- CMSIS：提供了处理器核心和设备的基本支持。它是HAL和应用程序的基础，使得代码可以在不同的Cortex-M设备之间移植。
- HAL驱动程序：封装了对STM32外设的操作，使开发者可以通过统一的API来操作不同的外设。它依赖于CMSIS提供的基础设施。
- BSP：提供了特定开发板的支持，使得在该开发板上的外设操作更加方便。它通常基于HAL驱动程序进行封装。
**使用流程**
1. 启动文件：在CMSIS/Device/ST/STM32F4xx/Source中，包含了启动代码和系统初始化代码。项目启动时，会首先执行这些代码。
2. HAL库初始化：在STM32F4xx_HAL_Driver/Inc和STM32F4xx_HAL_Driver/Src中，包含了对各种外设的初始化和操作函数。应用程序会调用这些函数来初始化和操作外设。
3. 板级支持：在BSP文件夹中，包含了特定开发板的支持代码。开发者可以调用这些代码来更方便地操作开发板上的外设。

###### 2. Drivers\STM32F1xx_HAL_Driver文件夹结构：
> - Src(Source):外设驱动源码
> - Inc(Include):外设驱动源码头文件

###### 3. HAL库文件介绍
> hal.:初始化等相关函数
> hal_cong.h：用户配置文件
> hal_def.h：通用的枚举类型数据和宏定义
> hal_cortex.：内核通用函数定义和声明
> hal_ppp.(ppp表示外设)：PPP外设驱动源码
> hal_ppp_ex.(特殊功能的驱动源码)：外设特殊的扩展功能的驱动源码
> ll_ppp.：LL库驱动源码，在部分STM32f1xx_hal_ppp.c和STM32f1xx_hal_ppp_ex.c中会被调用

>  _weak函数允许用户重定义

#### 4. 如何使用HAL库

1. Msp在外设.c文件中
2. HAL库的用户配置文件(stm32f1xx_hal_conf.h)
   1. 屏蔽宏或者不参与裁剪（使其不进行编译）
   2. 设置外部高速晶振频率（实际）
   2. 设置外部低速晶振频率（实际）
#### 5. HAL库使用注意事项

1. 使用HAL库出现问题，还是得通过参考手册检查是否硬件操作是否有问题
2. 尽量不通过修改库源码实现功能，这样不方便库更新
3. HAL库可能会存在错误，要有质疑精神
4. 有些HAL库API函数执行效率偏低，我们可能会直接通过操作寄存器的方式代替