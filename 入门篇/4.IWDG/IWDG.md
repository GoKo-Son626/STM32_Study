<!--
 * @Date: 2024-06-06
 * @LastEditors: GoKo-Son626
 * @LastEditTime: 2024-07-08
 * @FilePath: \STM32_Study\入门篇\4.IWDG\IWDG.md
 * @Description: IWDG的学习记录和编程实战
-->

# IWDG

> 内容目录：
> 
>       1. IWDG简介（了解）
>       2. IWDG工作原理（熟悉）
>       3. IWDG框图（熟悉）
>       4. IWDG寄存器（熟悉）
>       5. IWDG溢出时间计算（掌握）
>       6. IWDG配置步骤（掌握）
>       7. 编程实战：验证不及时喂狗，系统将复位重启（掌握）
>       8. 课堂总结（掌握）

#### 1. IWDG简介（了解）

> Independent watchdog，即独立看门狗
> - 能产生系统复位信号的计数器，可以输出复位信号
> - 递减的计数器(12位)，减为零时就会产生一个复位信号
时钟由独立的RC振荡器提供（可在待机和停止模式下运行）
> - 在计数器计数到0之前，重装载计数器的值，防止复位

**作用**:主要用于检测外界电磁干扰，或硬件异常导致的程序跑飞问题
**异常**:外界电磁干扰或者自身系统（硬件或软件）异常，
造成程序跑飞，如：陷入某个不正常的死循环，打断正常的程序运行
**应用**:在一些需要高稳定性的产品中，并且对时间精度要求较低的场合（因为时钟源来自LSI(RC振荡器)的时钟）
- 独立看门狗是异常处理的最后手段，不可依赖，应在设计时尽量避免异常的发生！

#### 2. IWDG工作原理（熟悉）

**IWDG工作原理**
![IWDG工作原理](Pictures/IWDG工作原理.png)
> CPU必须及时喂狗，否则系统复位重启！

#### 3. IWDG框图（熟悉）

**IWDG框图**
![IWDG框图](Pictures/IWDG框图.png)
> - **启用IWDG后，LSI时钟会自动开启**
> - LSI时钟频率并**不精确**，F1用40kHz，F4/F7/H7用32kHz进行计算即可

**IWDG 内部输入/输出信号**
| 信号名称  | 信号类型 | 说明              |
| --------- | -------- | ----------------- |
| LSI       | 数字信号 | LSI 时钟          |
| IWDG 复位 | 数字信号 | IWDG 复位信号输出 |

#### 4. IWDG寄存器（熟悉）

1. 键寄存器（IWDG_KR）

- 键寄存器可以看作是独立看门狗的控制寄存器
> 在键寄存器(IWDG_KR)中写入 0xCCCC，开始启用独看门狗；此时计数器开始从其复位值 0xFFF 递减计数。当计数器计数到末尾 0x000 时，会产生一个复位信(IWDG_RESET)。无论何时，只要键寄存器 IWDG_KR 中被写入 0xAAAA，IWDG_RLR 中的值就会被重新加载到计数器中从而避免产生看门狗复位
> **IWDG_PR 和 IWDG_RLR 寄存器具有写保护功能。要修改这两个寄存器的值，必须先向IWDG_KR 寄存器中写入 0x5555。将其他值写入这个寄存器将会打乱操作顺序，寄存器将重新被保护。重装载操作(即写入 0xAAAA)也会启动写保护功能**

2. 预分频寄存器（IWDG_PR）

- 该寄存器用来设置看门狗时钟（LSI）的分频系数，最低为 4，最高位 256，该寄存器是一个 32 位的寄存器，但是我们只用了最低 3 位，其他都是保留位

3. 重载寄存器（IWDG_RLR）

- 该寄存器用来保存重装载到计数器中的值。该寄存器也是一个 32 位寄存器，只有低 12 位是有效的。

#### 5. IWDG溢出时间计算（掌握）

> 通过该函数设置看门狗的分频系数，和重装载的值。
**看门狗的喂狗时间（也就是看门狗溢出时间）的计算方式为：**

### **Tout=((4×2^prer) ×rlr) /40**

**其中 Tout 为看门狗溢出时间（单位为 ms）**
**prer 为看门狗时钟预分频值（IWDG_PR 值），范围为 0~7**
**rlr 为看门狗的重装载值（IWDG_RLR 的值）**
#### 6. IWDG配置步骤（掌握）

###### 1. HAL_IWDG_Init(&g_iwdg_handle);

#### 7. 编程实战：验证不及时喂狗，系统将复位重启（掌握）

**IWDG初始化**
```c
void iwdg_init(uint8_t prer, uint16_t rlr)
{
    g_iwdg_handle.Instance = IWDG;
    g_iwdg_handle.Init.Prescaler = prer; /* 设置IWDG分频系数 */
    g_iwdg_handle.Init.Reload = rlr;     /* 重装载值 */
    HAL_IWDG_Init(&g_iwdg_handle);       /* 初始化IWDG并启动 */
}
```
**及时喂狗**
```c
void iwdg_feed(void)
{
    HAL_IWDG_Refresh(&g_iwdg_handle); /* 重装载计数器 */
}
```